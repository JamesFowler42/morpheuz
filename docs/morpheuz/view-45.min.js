function mConst(){return{chartBottom:-50,chartTop:4000,swpAppStoreUrl:"https://itunes.apple.com/app/smartwatch-pro-for-pebble/id673907094?mt=8&at=10lIFm&pt=409665&ct=morpheuz_web",displayDateFmt:"WWW, NNN dd, yyyy hh:mm",iosDateFormat:"dd N yyyy hh:mm",swpUrlDate:"yyyy-MM-ddThh:mm:00",emailAddressMandatory:"valid email address is required",sendingEmail:"Sending...",url:"http://ui.morpheuz.net/morpheuz/view-",twitterWebIntentUrl:"https://twitter.com/intent/tweet?hashtags=morpheuz,tweetMySleep&text=",unableToFindTweetText:"Meh",numberOfSamples:60}}function buildGraphDataSet(e,f,c){var d=new Date(e);for(var b=0;b<f.length;b++){if(f[b]===""){continue}var a=new Array();a[0]=d;a[1]=parseInt(f[b],10);if(a[1]<0){a[1]=null}c[b]=a;d=d.addMinutes(mCommonConst().sampleIntervalMins)}}function populateIgnore(f,c,h,a){var e=a/h.length;var d=new Date(f);for(var b=0;b<h.length;b++){if(h[b]===""){continue}if(parseInt(h[b],10)==-2){var g={verticalLine:{name:"ignore",x:d,lineWidth:e,yOffset:0,color:"#AAAAAA",shadow:false}};c.show=true;c.objects.push(g)}d=d.addMinutes(mCommonConst().sampleIntervalMins)}}function startStopAlarm(h,k,r,l,p,g,j,f){if(h){var q=fixLen(k)+fixLen(r);var o=fixLen(l)+fixLen(p);var s=new Date(g);var a=null;var c=null;for(var n=0;n<f.length;n++){var e=s.format("hhmm");var m=s;s=s.addMinutes(mCommonConst().sampleIntervalMins);var d=s.format("hhmm");if(a===null&&q>=e&&q<=d){a=returnAbsoluteMatch(m,s,q)}if(c===null&&o>=e&&o<=d){c=returnAbsoluteMatch(m,s,o)}if(c!==null&&a!==null){break}}if(a!==null){var t={dashedVerticalLine:{name:"start",x:a,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(76, 217, 100)",shadow:false}};j.show=true;j.objects.push(t)}if(c!==null){var b={dashedVerticalLine:{name:"end",x:c,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(255, 59, 48)",shadow:false}};j.show=true;j.objects.push(b)}}}function calculateStatsPlusCanvas(d,g,f,b){var a=calculateStats(d,g,f);if(a&&a.tbegin){var e={verticalLine:{name:"begin",x:a.tbegin,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};b.show=true;b.objects.push(e)}if(a&&a.tends){var c={verticalLine:{name:"endstop",x:a.tends,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};b.show=true;b.objects.push(c)}return a}function setTweet(a){$.ajaxSetup({scriptCharset:"utf-8",contentType:"application/json; charset=utf-8"});$.getJSON("tweetmysleep.json?v="+new Date().getTime(),function(d){if(typeof d!=="undefined"&&typeof d.tweets!=="undefined"){var b=d.tweets.star[a.stars];var c=Math.floor(Math.random()*b.length);var e=a.totalStr+" ("+a.deepStr+") - "+b[c];var f=mConst().twitterWebIntentUrl+encodeURIComponent(e);$("#tweet").attr("href",f)}}).error(function(b){var c=mConst().twitterWebIntentUrl+encodeURIComponent(mConst().unableToFindTweetText);$("#tweet").attr("href",c)})}function buildStripeChart(a){setTimeout(function(){var j=$("#chart1 .jqplot-event-canvas").css("left");var g=$("#chart1 .jqplot-event-canvas").css("width");var b=parseFloat(g);$("#sleepBar").attr("width",b);$("#sleepBar").css("left",j);$("#sleepBar").css("width",g);var h=document.getElementById("sleepBar");var l=h.getContext("2d");var d=l.createLinearGradient(0,0,b,0);d.addColorStop(0,"#555555");for(var e=0;e<a.length;e++){if(a[e]===""){continue}var f=(e+1)/61;var k=parseInt(a[e],10);if(k>mThres().awakeAbove){d.addColorStop(f,"#55AAFF")}else{if(k>mThres().lightAbove){d.addColorStop(f,"#0055FF")}else{if(k==-1||k==-2){d.addColorStop(f,"#AAAAAA")}else{d.addColorStop(f,"#0000AA")}}}}d.addColorStop(1,"#555555");l.fillStyle=d;l.fillRect(0,0,b,30)},500)}function buildEnvironment(a,d,b,c){if(!c){return}function e(g,l,f,j,o){if(l===null||l==="null"||typeof l==="undefined"){return}var h=l.getTime();if(isNaN(h)){return}var k=g.getTime();var n=h-k;var m=mCommonConst().sampleIntervalMins*60*1000*mConst().numberOfSamples;var i=n/m;if(i<0){if(o.negCloseToZero<i){o.negCloseToZero=i;o.zeroColor=f}return}else{if(i>1){if(o.valCloseToOne>i){o.valCloseToOne=i;o.oneColor=f}return}}j.addColorStop(i,f)}setTimeout(function(){var B=$("#chart1 .jqplot-event-canvas").css("left");var k=$("#chart1 .jqplot-event-canvas").css("width");var f=parseFloat(k);$("#sunbar").attr("width",f);$("#sunbar").css("left",B);$("#sunbar").css("width",k);$("#moonbar").attr("width",f);$("#moonbar").css("left",B);$("#moonbar").css("width",k);try{var t=SunCalc.getTimes(a,d,b);var o=SunCalc.getTimes(a.addMinutes(60*24),d,b);var i=document.getElementById("sunbar");var n=i.getContext("2d");var C=n.createLinearGradient(0,0,f,0);var h="#FBF6D9";var y="#FFE87C";var u=y;var l="#151B54";var z="darkblue";var m={negCloseToZero:-9999,zeroColor:z,oneColor:z,valCloseToOne:9999};e(a,t.sunrise,y,C,m);e(a,t.sunriseEnd,h,C,m);e(a,t.sunsetStart,u,C,m);e(a,t.sunset,z,C,m);e(a,t.solarNoon,h,C,m);e(a,t.nadir,l,C,m);e(a,o.sunrise,y,C,m);e(a,o.sunriseEnd,h,C,m);e(a,o.sunsetStart,u,C,m);e(a,o.sunset,z,C,m);e(a,o.solarNoon,h,C,m);e(a,o.nadir,l,C,m);e(a,t.night,z,C,m);e(a,t.nightEnd,z,C,m);e(a,o.night,z,C,m);e(a,o.nightEnd,z,C,m);C.addColorStop(0,m.zeroColor);C.addColorStop(1,m.oneColor);n.fillStyle=C;n.fillRect(0,0,f,30)}catch(j){console.log("Sun calc failed "+j.message)}try{var w=SunCalc.getMoonIllumination(a);var v=Math.round(w.phase*8);if(v>=8){v=0}$("#moonimg").attr("src","img/moon-"+v+".png");var A=SunCalc.getMoonTimes(a,d,b);var s=SunCalc.getMoonTimes(a.addMinutes(60*24),d,b);var q=document.getElementById("moonbar");var r=q.getContext("2d");var g=r.createLinearGradient(0,0,f,0);var p=(v===3||v===4||v===5)?"white":((v===0)?"black":"silver");var x="black";m={negCloseToZero:-9999,zeroColor:x,oneColor:x,valCloseToOne:9999};e(a,A.rise,p,g,m);e(a,s.rise,p,g,m);e(a,A.set,x,g,m);e(a,s.set,x,g,m);g.addColorStop(0,m.zeroColor);g.addColorStop(1,m.oneColor);r.fillStyle=g;r.fillRect(0,0,f,30)}catch(j){console.log("Moon calc failed "+j.message)}},500)}$("document").ready(function(){adjustForViewport();document.ios=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i);if(document.ios){$(".android").hide()}else{$(".ios").hide()}var D=getParameterByName("base");var q=new Date().valueOf();if(D!==""&&D!=="null"){q=parseInt(D,10)}var I=getParameterByName("graph");var C=getParameterByName("graphx");var i=getParameterByName("fromhr");var p=getParameterByName("frommin");var G=getParameterByName("tohr");var K=getParameterByName("tomin");var E=getParameterByName("smart");var n=getParameterByName("vers");var H=getParameterByName("goneoff");var y=getParameterByName("emailto");var O=getParameterByName("potoken");var S=getParameterByName("pouser");var m=getParameterByName("postat");var B=getParameterByName("swpdo");var w=getParameterByName("lifxtoken");var h=getParameterByName("lifxtime");var R=getParameterByName("swpstat");var P=getParameterByName("noset");var l=getParameterByName("token");var o=getParameterByName("exptime");var k=getParameterByName("usage");var e=getParameterByName("lazarus");var t=getParameterByName("hueip");var s=getParameterByName("hueuser");var z=getParameterByName("hueid");var x=getParameterByName("ifkey");var c=getParameterByName("ifserver");var g=getParameterByName("ifstat");var b=getParameterByName("age");var T=getParameterByName("doemail");var j=getParameterByName("estat");var Q=getParameterByName("zz");var d=getParameterByName("lat");var a=getParameterByName("long");var v=getParameterByName("return_to");if(v===""){v="pebblejs://close#"}var u=E==="Y";var f=P==="Y";if(f){$(".noset").hide()}$("#emailto").val(y);$("#ptoken").val(O);$("#puser").val(S);$("#lifxToken").val(w);$("#lifxTime").val(h);$("#swpdo").prop("checked",B==="Y");$("#presult").text(m);$("#swpstat").text(R);$("#exptime").text(o);$("#usage").prop("checked",k!=="N");$("#hueip").val(t);$("#hueuser").val(s);$("#hueid").val(z);$("#lazarus").prop("checked",e!=="N");$("#ifkey").val(x);$("#ifserver").val(c);$("#ifstat").text(g);$("#age").val(b);$("#doemail").prop("checked",T==="Y");$("#estat").text(j);if(j==="OK"){$("#liemail").addClass("green");$("#estat").addClass("green")}else{if(j===""||j===null||j==="Disabled"){$("#liemail").addClass("blue");$("#estat").addClass("blue")}else{$("#liemail").addClass("red");$("#estat").addClass("red")}}if(m==="OK"){$("#lipushover").addClass("green");$("#presult").addClass("green")}else{if(m===""||m===null||m==="Disabled"){$("#lipushover").addClass("blue");$("#presult").addClass("blue")}else{$("#lipushover").addClass("red");$("#presult").addClass("red")}}if(R==="OK"){$("#liswp").addClass("green");$("#swpstat").addClass("green")}else{if(R===""||R===null||R==="Disabled"){$("#liswp").addClass("blue");$("#swpstat").addClass("blue")}else{$("#liswp").addClass("red");$("#swpstat").addClass("red")}}if(w===""){$("#lilifx").addClass("blue")}else{$("#lilifx").addClass("green")}if(t===""){$("#lihue").addClass("blue")}else{$("#lihue").addClass("green")}if(k!=="N"){$("#liusage").addClass("green")}else{$("#liusage").addClass("blue")}if(e!=="N"){$("#lilazarus").addClass("green")}else{$("#lilazarus").addClass("blue")}if(g==="OK"){$("#liif").addClass("green");$("#ifstat").addClass("green")}else{if(g===""||g===null||g==="Disabled"){$("#liif").addClass("blue");$("#ifstat").addClass("blue")}else{$("#liif").addClass("red");$("#ifstat").addClass("red")}}$("li.red").removeClass("liclosed").addClass("liopen");$("#version").text((parseFloat(n)/10).toFixed(1));$("#sleep-time").text(new Date(q).format(mConst().displayDateFmt));if((new Date().valueOf())%10===0){$("#info-message").css("display","block")}$(".licollapse > p").click(function(){if($(this).parent().hasClass("liopen")){$(this).parent().removeClass("liopen").addClass("liclosed")}else{$(this).parent().removeClass("liclosed").addClass("liopen")}});if(!f){setScreenMessageBasedOnVersion(n)}var N=[];if(I===""&&C!==""){N=splitupFromGraphx(C)}else{if(I!==""&&C===""){N=I.split("!")}else{console.log("No graph or graphx supplied (or both!)")}}var F=new Array();buildGraphDataSet(q,N,F);var r={show:false,objects:[]};populateIgnore(q,r,N,$("#chart1").width());startStopAlarm(u,i,p,G,K,q,r,N);var J=calculateStatsPlusCanvas(q,H,N,r);document.morpheuzInfo={splitup:N,base:new Date(q),pLat:parseFloat(d),pLong:parseFloat(a),havePosition:(d!==""&&a!=="")};if(!document.morpheuzInfo.havePosition){$(".environment").hide()}var Q=parseInt(Q,10);if(isNaN(Q)){Q=0}var L=buildRecommendationPhrase(b,J,Q);$("#stats").text(L.summary);$("#ttotal").text(L.total);$("#tawake").text(L.awake);$("#tlight").text(L.light);$("#tdeep").text(L.deep);$("#tignore").text(L.ignore);if(!f){setTweet(L)}if(J.tbegin!==null&&J.tends!==null){$("#swpnodata").hide();$("#tstarts").text(J.tbegin.format(mConst().iosDateFormat));$("#tends").text(J.tends.format(mConst().iosDateFormat));var A="swpro2hk://?source=Morpheuz&starts="+J.tbegin.format(mConst().swpUrlDate)+"&ends="+J.tends.format(mConst().swpUrlDate);if(l!=null&&l!==""){A+="&at="+l}$("#swp").prop("href",A);if(!f){$("#swp").click(function(){setTimeout(function(){window.location.href="pebblejs://close"},250)})}}else{$("#swp").hide()}$("#swplink").prop("href",mConst().swpAppStoreUrl);$("#swplink").click(function(){setTimeout(function(){window.location.href="pebblejs://close"},250)});var M=[["Restless",J.awake],["Light",J.light],["Deep",J.deep],["Ignore",J.ignore]];$(document).ready(function(){document.plot1=$.jqplot("chart1",[F],{grid:{background:"#2066C7",gridLineColor:"#1E75D7",borderColor:"#1E75D7",shadow:false},animate:true,canvasOverlay:r,series:[{showMarker:false,breakOnNull:true,color:"#40ADEB",label:new Date(q).format("yyyy-MM-dd"),shadow:false}],axesDefaults:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,showTicks:false,showTickMarks:false},legend:{show:false,location:"ne"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%R",angle:-30,fontSize:"8pt",textColor:"#40ADEB"},tickInterval:"1 hour",pad:0,showTicks:true,showTickMarks:true,min:new Date(q)},yaxis:{ticks:[mConst().chartBottom,mThres().lightAbove,mThres().awakeAbove,mConst().chartTop],labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:"Movement",min:mConst().chartBottom,max:mConst().chartTop,labelOptions:{textColor:"#1898FF"}}}});document.plot2=jQuery.jqplot("chart2",[M],{grid:{background:"#FF7D48",borderColor:"#FF7D48",shadow:false},seriesColors:["#FFFF92","#FFA966","#FF3C31","rgb(130,130,130)"],seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{showDataLabels:true,shadow:false}},legend:{show:true,location:"e"}});buildStripeChart(document.morpheuzInfo.splitup);buildEnvironment(document.morpheuzInfo.base,document.morpheuzInfo.pLat,document.morpheuzInfo.pLong,document.morpheuzInfo.havePosition)});$(".save").click(function(){var U={action:"save",emailto:safeTrim($("#emailto").val()),pouser:safeTrim($("#puser").val()),potoken:safeTrim($("#ptoken").val()),swpdo:$("#swpdo").is(":checked")?"Y":"N",usage:$("#usage").is(":checked")?"Y":"N",lifxtoken:safeTrim($("#lifxToken").val()),lifxtime:safeTrim($("#lifxTime").val()),hueip:safeTrim($("#hueip").val()),hueuser:safeTrim($("#hueuser").val()),hueid:safeTrim($("#hueid").val()),lazarus:$("#lazarus").is(":checked")?"Y":"N",testsettings:$("#testsettings").is(":checked")?"Y":"N",ifkey:safeTrim($("#ifkey").val()),ifserver:safeTrim($("#ifserver").val()),age:safeTrim($("#age").val()),doemail:$("#doemail").is(":checked")?"Y":"N"};document.location=v+encodeURIComponent(JSON.stringify(U))});$("#mail").removeAttr("disabled");$("#mail").click(function(){var U=$("#emailto").val();if(U===""||!validateEmail(U)){$("#emailSendResult").text(mConst().emailAddressMandatory);$("#emailSendResult").addClass("red");return}var X=generateCopyLinkData(q,N,u,i,p,G,K,H,Q);var W=mConst().url+n+".html?base="+q+"&fromhr="+i+"&tohr="+G+"&frommin="+p+"&tomin="+K+"&smart="+E+"&vers="+n+"&goneoff="+H+"&token="+l+"&age="+b+"&emailto="+encodeURIComponent(U)+"&noset=Y&zz="+Q+"&lat"+d+"&long="+a;if(I===""){W+="&graphx="+C}else{W+="&graph="+I}var V=buildEmailJsonString(U,q,W,X);$("#mail").attr("disabled","disabled");$("#emailSendResult").removeClass("red").removeClass("green");$("#emailSendResult").text(mConst().sendingEmail);sendMailViaServer(V,function(Y,Z){if(Y===1){$("#emailSendResult").addClass("green")}else{$("#emailSendResult").addClass("red")}$("#emailSendResult").text(Z);$("#mail").removeAttr("disabled")})});$("#age").keyup(function(){var U=$("#age").val();var V=buildRecommendationPhrase(U,J,Q);$("#stats").text(V.summary);if(!f){setTweet(V)}});$("#lesssummary").click(function(){$("#summarytable").hide();$("#lesssummary").hide();$("#moresummary").show();if(window.localStorage){window.localStorage.setItem("lesssummary","true")}});$("#moresummary").click(function(){$("#summarytable").show();$("#moresummary").hide();$("#lesssummary").show();if(window.localStorage){window.localStorage.setItem("lesssummary","false")}});if(window.localStorage&&window.localStorage.getItem("lesssummary")==="true"){$("#summarytable").hide();$("#lesssummary").hide();$("#moresummary").show()}});function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c=new RegExp("[\\?&]"+a+"=([^&#]*)"),b=c.exec(location.search);return b==null?"":decodeURIComponent(b[1].replace(/\+/g," "))}function setScreenMessageBasedOnVersion(a){$(".versproblem").show();$.ajaxSetup({scriptCharset:"utf-8",contentType:"application/json; charset=utf-8"});$.getJSON("currentversion.json?v="+new Date().getTime(),function(d){if(typeof d!=="undefined"&&typeof d.version!=="undefined"){var c=parseInt(d.version,10);var b=parseInt(a,10);$(".versproblem").hide();if(c>b){$(".verswarning").show()}else{if(c<b){$(".versbeta").show()}}}}).error(function(b){$(".versproblem").text("Error attempting to find the current version: "+JSON.stringify(b))})}function scaleToViewport(){var a=$(window).width();if(a>800){a=800}else{if(a<320){a=320}}a-=5;$(".vpwidth").width(a);$(".vpheight").height(a*250/318);if(typeof document.plot1!=="undefined"){document.plot1.replot();buildStripeChart(document.morpheuzInfo.splitup);buildEnvironment(document.morpheuzInfo.base,document.morpheuzInfo.pLat,document.morpheuzInfo.pLong,document.morpheuzInfo.havePosition)}if(typeof document.plot2!=="undefined"){document.plot2.replot()}}function adjustForViewport(){scaleToViewport();$(window).resize(scaleToViewport)}function validateEmail(a){var b=/[^\s@]+@[^\s@]+\.[^\s@]+/;return b.test(a)}function safeTrim(b){try{return b.trim()}catch(a){return b}}function splitupFromGraphx(f){var e=[];var a=f.match(/.{1,3}/g);for(var d=0;d<a.length;d++){var c=a[d];var b=0;if(c==="fff"){b=-1}else{if(c==="ffe"){b=-2}else{b=parseInt(c,16)}}e.push(b.toString())}return e}function mCommonConst(){return{sampleIntervalMins:10,emailUrl:"http://ui.morpheuz.net/morpheuz/json_email.php",emailToken:"morpheuz20"}}function mCommonLang(){return{noSleep:"No sleep has been recorded yet. If this is incorrect, select the 'Resend' menu option on your watch and check again in a few minutes.",sleepSummary:"Your body and brain requires {0} to {1} hours sleep every night. Last night was {2} as you slept for {3}. Of that sleep: {4} was restless; {5} was light; {6} was deep; {7} was excluded as it either wasn't recorded, or you marked it to be ignored.",sleepSummaryNoRecommend:"You slept for {0}. Of that sleep: {1} was restless; {2} was light; {3} was deep; {4} was excluded as it either wasn't recorded, or you marked it to be ignored.",minutes:" minutes",minute:" minute",hour:" hour",hours:" hours",none:"none",tooLittle:"too little",tooMuch:"too much",ideal:"ideal",okResponse:"Sent OK",failResponse:"Failed to send with ",failGeneral:"Failed to send",emailHeader:"<h2>CSV Sleep data</h2>",emailHeader2:"<h2>Chart Display</h2>",emailFooter1:"<br/>Note: -1 is no data captured, -2 is ignore set, ALARM, START and END nodes represent smart alarm actual, start and end",emailFooter2:"<br/><br/><small>Please don't reply, this is an unmonitored mailbox</small><br/>",report:"Report",snoozeText:" You hit snooze {0} times.",snoozeTextOnce:" You hit snooze once.",snoozeTextTwice:" You hit snooze twice."}}function mThres(){return{awakeAbove:1000,lightAbove:120}}Date.prototype.format=function(d){var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"i+":this.getHours()+1,"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(d)){d=d.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var c in e){if(new RegExp("("+c+")").test(d)){d=d.replace(RegExp.$1,RegExp.$1.length==1?e[c]:("00"+e[c]).substr((""+e[c]).length))}}if(/(N+)/.test(d)){d=d.replace(RegExp.$1,b[this.getMonth()])}if(/(W+)/.test(d)){d=d.replace(RegExp.$1,a[this.getDay()])}return d};Date.prototype.addMinutes=function(b){var a=new Date(this.getTime());return new Date(a.getTime()+b*60000)};String.prototype.format=function(){var c=this;for(var a=0;a<arguments.length;a++){var b="{"+a+"}";c=c.replace(b,arguments[a])}return c};function nvl(b,a){return b===null||b==="null"||typeof b==="undefined"?a:b}function fixLen(a){if(a===null||a.length>1){return a}return"0"+a}function hrsmin(d){if(d===0){return mCommonLang().none}var a="";var b=Math.floor(d/60);if(b==1){a+=b+mCommonLang().hour}else{if(b>1){a+=b+mCommonLang().hours}}var c=d%60;if(c!==0){if(b===0){if(c===1){a+=fixLen(String(c))+mCommonLang().minute}else{a+=fixLen(String(c))+mCommonLang().minutes}}else{a+=" "+fixLen(String(c))}}return a}function calculateStats(h,m,g){var b=new Date(h);var r=true;var c=null;var a=null;var s=null;var u=null;var l=null;var n=null;for(var w=0;w<g.length;w++){if(g[w]===""){continue}var y=parseInt(g[w],10);var e=b.format("hhmm");var q=b;b=b.addMinutes(mCommonConst().sampleIntervalMins);var d=b.format("hhmm");if(m!="N"&&m>=e&&m<=d){a=returnAbsoluteMatch(q,b,m);l=w;break}else{if(y!=-1&&y!=-2&&y<=mThres().awakeAbove){if(r){c=q;u=w;r=false}s=b;n=w}}}if(a===null&&s!==null){a=s;l=n}var o=0;var v=0;var f=0;var x=0;if(u!==null&&l!==null){for(var t=u;t<=l;t++){if(g[t]===""){continue}var k=parseInt(g[t],10);if(k==-1||k==-2){x++}else{if(k>mThres().awakeAbove){o++}else{if(k>mThres().lightAbove){f++}else{v++}}}}}var p=a-c;var z=Math.round((p/1000)/60);return{tbegin:c,tends:a,deep:v*mCommonConst().sampleIntervalMins,light:f*mCommonConst().sampleIntervalMins,awake:o*mCommonConst().sampleIntervalMins,ignore:x*mCommonConst().sampleIntervalMins,total:z}}function returnAbsoluteMatch(e,b,c){var a=e;while(a.getTime()<b.getTime()){var d=a.format("hhmm");if(c===d){return a}a=a.addMinutes(1)}return e}function generateRecommendation(d,f){if(isNaN(d)){return null}var c=parseInt(d,10);if(isNaN(c)){return null}var e=0;var a=0;if(c<1){return"-"}else{if(c<3){e=11;a=14}else{if(c<6){e=10;a=13}else{if(c<14){e=9;a=11}else{if(c<18){e=8;a=10}else{if(c<64){e=7;a=9}else{e=7;a=8}}}}}}var h=Math.floor(f/60);var b="";var g=0;if(h<e){b=mCommonLang().tooLittle;g=f-e*60}else{if(h>a){b=mCommonLang().tooMuch;g=f-a*60}else{b=mCommonLang().ideal}}return{min:e,max:a,view:b,diff:g}}function determineStars(b,c){if(b===null){return 0}var a=5;if(c>0){a--}if(b.diff<=-90){a--}if(b.diff<=-60){a--}if(b.diff<=-30){a--}if(b.diff>=60){a--}return a}function buildRecommendationPhrase(j,h,b){if(h.total===0){return{summary:mCommonLang().noSleep,total:"-",awake:"-",light:"-",deep:"-",ignore:"-",stars:0,totalStr:"-",deepStr:"-"}}var f=generateRecommendation(j,h.total);var d=hrsmin(h.total);var a=hrsmin(h.awake);var i=hrsmin(h.light);var k=hrsmin(h.deep);var g=hrsmin(h.ignore);var e=determineStars(f,b);var c;if(f!==null){c=mCommonLang().sleepSummary.format(f.min,f.max,f.view,d,a,i,k,g)}else{c=mCommonLang().sleepSummaryNoRecommend.format(d,a,i,k,g)}if(b>2){c+=mCommonLang().snoozeText.format(b)}else{if(b==1){c+=mCommonLang().snoozeTextOnce}else{if(b==2){c+=mCommonLang().snoozeTextTwice}}}return{summary:c,total:d,awake:a,light:i,deep:k,ignore:g,stars:e,totalStr:d,deepStr:k}}function generateCopyLinkData(b,l,k,n,h,m,e,d,a){var c=new Date(b);var g="<pre>";for(var f=0;f<l.length;f++){if(l[f]===""){continue}g=g+c.format("hh:mm")+","+l[f]+"<br/>";c=c.addMinutes(mCommonConst().sampleIntervalMins)}if(k){g=g+n+":"+h+",START<br/>"+m+":"+e+",END<br/>";if(d!="N"){var j=d.substr(0,2)+":"+d.substr(2,2);g=g+j+",ALARM<br/>"}g=g+a+",SNOOZES<br/>"}return{body:g+"</pre>"}}function sendMailViaServer(a,e){try{var d="email="+encodeURIComponent(JSON.stringify(a));var c=new XMLHttpRequest();c.open("POST",mCommonConst().emailUrl,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.setRequestHeader("X-Client-token",mCommonConst().emailToken);c.onreadystatechange=function(f){if(c.readyState==4){if(c.status==200){e(1,mCommonLang().okResponse)}else{e(0,mCommonLang().failResponse+c.status)}}};c.onerror=function(f){e(0,mCommonLang().failGeneral)};c.send(d)}catch(b){e(0,mCommonLang().failResponse+b.message)}}function buildEmailJsonString(b,f,e,d){var a="<a href='"+e+"'>"+mCommonLang().report+"</a><br/>";var c={from:"Morpheuz <noreply@morpheuz.co.uk>",to:b,subject:"Morpheuz-"+new Date(f).format("yyyy-MM-dd"),message:mCommonLang().emailHeader2+a+mCommonLang().emailHeader+d.body+mCommonLang().emailFooter1+mCommonLang().emailFooter2};return c}(function(){var v=Math.PI,a=Math.sin,c=Math.cos,A=Math.tan,p=Math.asin,l=Math.atan2,s=Math.acos,E=v/180;var C=1000*60*60*24,g=2440588,H=2451545;function w(e){return e.valueOf()/C-0.5+g}function D(e){return new Date((e+0.5-g)*C)}function k(e){return w(e)-H}var B=E*23.4397;function h(J,e){return l(a(J)*c(B)-A(e)*a(B),c(J))}function q(J,e){return p(a(e)*c(B)+c(e)*a(B)*a(J))}function x(e,J,K){return l(a(e),c(e)*a(J)-A(K)*c(J))}function m(e,J,K){return p(a(J)*a(K)+c(J)*c(K)*c(e))}function y(J,e){return E*(280.16+360.9856235*J)-e}function j(e){if(e<0){e=0}return 0.0002967/Math.tan(e+0.00312536/(e+0.08901179))}function G(e){return E*(357.5291+0.98560028*e)}function u(K){var J=E*(1.9148*a(K)+0.02*a(2*K)+0.0003*a(3*K)),e=E*102.9372;return K+J+e+v}function z(J){var K=G(J),e=u(K);return{dec:q(e,0),ra:h(e,0)}}var i={};i.getPosition=function(J,N,e){var M=E*-e,L=E*N,O=k(J),P=z(O),K=y(O,M)-P.ra;return{azimuth:x(K,L,P.dec),altitude:m(K,L,P.dec)}};var o=i.times=[[-0.833,"sunrise","sunset"],[-0.3,"sunriseEnd","sunsetStart"],[-6,"dawn","dusk"],[-12,"nauticalDawn","nauticalDusk"],[-18,"nightEnd","night"],[6,"goldenHourEnd","goldenHour"]];i.addTime=function(J,K,e){o.push([J,K,e])};var f=0.0009;function t(J,e){return Math.round(J-f-e/(2*v))}function r(e,J,K){return f+(e+J)/(2*v)+K}function d(J,K,e){return H+J+0.0053*a(K)-0.0069*a(2*e)}function F(e,J,K){return s((a(e)-a(J)*a(K))/(c(J)*c(K)))}function n(N,J,O,K,e,P,Q){var S=F(N,O,K),R=r(S,J,e);return d(R,P,Q)}i.getTimes=function(aa,K,ab){var J=E*-ab,e=E*K,Y=k(aa),U=t(Y,J),T=r(0,J,U),O=G(T),P=u(O),S=q(P,0),Z=d(T,O,P),W,X,N,R,V;var Q={solarNoon:D(Z),nadir:D(Z-0.5)};for(W=0,X=o.length;W<X;W+=1){N=o[W];R=n(N[0]*E,J,e,S,U,O,P);V=Z-(R-Z);Q[N[1]]=D(V);Q[N[2]]=D(R)}return Q};function I(P){var J=E*(218.316+13.176396*P),Q=E*(134.963+13.064993*P),O=E*(93.272+13.22935*P),K=J+E*6.289*a(Q),e=E*5.128*a(O),N=385001-20905*c(Q);return{ra:h(K,e),dec:q(K,e),dist:N}}i.getMoonPosition=function(J,O,P){var e=E*-P,L=E*O,M=k(J),N=I(M),R=y(M,e)-N.ra,K=m(R,L,N.dec),Q=l(a(R),A(L)*c(N.dec)-a(N.dec)*c(R));K=K+j(K);return{azimuth:x(R,L,N.dec),altitude:K,distance:N.dist,parallacticAngle:Q}};i.getMoonIllumination=function(J){var P=k(J),K=z(P),e=I(P),M=149598000,L=s(a(K.dec)*a(e.dec)+c(K.dec)*c(e.dec)*c(K.ra-e.ra)),N=l(M*a(L),e.dist-M*c(L)),O=l(c(K.dec)*a(K.ra-e.ra),a(K.dec)*c(e.dec)-c(K.dec)*a(e.dec)*c(K.ra-e.ra));return{fraction:(1+c(N))/2,phase:0.5+0.5*N*(O<0?-1:1)/Math.PI,angle:O}};function b(e,J){return new Date(e.valueOf()+J*C/24)}i.getMoonTimes=function(aa,K,ad,P){var T=new Date(aa);if(P){T.setUTCHours(0,0,0,0)}else{T.setHours(0,0,0,0)}var L=0.133*E,Q=i.getMoonPosition(T,K,ad).altitude-L,O,N,J,U,ac,ab,V,e,Z,M,Y,X,S;for(var W=1;W<=24;W+=2){O=i.getMoonPosition(b(T,W),K,ad).altitude-L;N=i.getMoonPosition(b(T,W+1),K,ad).altitude-L;ac=(Q+N)/2-O;ab=(N-Q)/2;V=-ab/(2*ac);e=(ac*V+ab)*V+O;Z=ab*ab-4*ac*O;M=0;if(Z>=0){S=Math.sqrt(Z)/(Math.abs(ac)*2);Y=V-S;X=V+S;if(Math.abs(Y)<=1){M++}if(Math.abs(X)<=1){M++}if(Y<-1){Y=X}}if(M===1){if(Q<0){J=W+Y}else{U=W+Y}}else{if(M===2){J=W+(e<0?X:Y);U=W+(e<0?Y:X)}}if(J&&U){break}Q=N}var R={};if(J){R.rise=b(T,J)}if(U){R.set=b(T,U)}if(!J&&!U){R[e>0?"alwaysUp":"alwaysDown"]=true}return R};if(typeof define==="function"&&define.amd){define(i)}else{if(typeof module!=="undefined"){module.exports=i}else{window.SunCalc=i}}}());