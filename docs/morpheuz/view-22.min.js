function mConst(){var a={awakeAbove:1000,lightAbove:120,sampleIntervalMins:10,vers:22};return a}function hrsmin(c){var a=Math.floor(c/60);var b=c%60;return fixLen(String(a))+":"+fixLen(String(b))}Date.prototype.format=function(b){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"i+":this.getHours()+1,"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in c){if(new RegExp("("+a+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length==1?c[a]:("00"+c[a]).substr((""+c[a]).length))}}return b};Date.prototype.addMinutes=function(b){var a=new Date(this.getTime());return new Date(a.getTime()+b*60000)};function setSelectedValue(c,a){for(var b=0;b<c.options.length;b++){if(c.options[b].text==a){c.options[b].selected=true;return}}}function setTextValue(b,a){b.value=fixLen(a)}function getSelectedValue(a){return a.options[a.selectedIndex].value}function getTextValue(c,a){var b=parseInt(c.value,10);if(isNaN(b)||(a&&(b<0||b>23))||(!a&&(b<0||b>59))){c.style.backgroundColor="red";return"X"}return fixLen(String(b))}function fixLen(a){if(a==null||a.length>1){return a}return"0"+a}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c=new RegExp("[\\?&]"+a+"=([^&#]*)"),b=c.exec(location.search);return b==null?"":decodeURIComponent(b[1].replace(/\+/g," "))}document.ios=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i);if(document.ios){$(".android").hide()}else{$(".ios").hide()}var baseStr=getParameterByName("base");var base=new Date().valueOf();if(baseStr!=""&&baseStr!="null"){base=parseInt(baseStr,10)}var graph=getParameterByName("graph");var fromhr=getParameterByName("fromhr");var frommin=getParameterByName("frommin");var tohr=getParameterByName("tohr");var tomin=getParameterByName("tomin");var smart=getParameterByName("smart");var inverse=getParameterByName("inverse");var vers=getParameterByName("vers");var goneoff=getParameterByName("goneoff");var emailto=decodeURIComponent(getParameterByName("emailto"));var xuser=decodeURIComponent(getParameterByName("xuser"));var xpass=decodeURIComponent(getParameterByName("xpass"));var xkey=decodeURIComponent(getParameterByName("xkey"));var smartOn=smart=="Y";var inverseOn=inverse=="Y";document.getElementById("emailto").value=emailto;document.getElementById("smartalarm").checked=smartOn;document.getElementById("inverse").checked=inverseOn;if(document.ios){setSelectedValue(document.getElementById("safromhour"),fromhr);setSelectedValue(document.getElementById("safrommin"),frommin);setSelectedValue(document.getElementById("satohour"),tohr);setSelectedValue(document.getElementById("satomin"),tomin)}else{setTextValue(document.getElementById("safromhourtxt"),fromhr);setTextValue(document.getElementById("safrommintxt"),frommin);setTextValue(document.getElementById("satohourtxt"),tohr);setTextValue(document.getElementById("satomintxt"),tomin)}document.getElementById("version").textContent=parseInt(vers,10)/10;if(vers!=mConst().vers){document.getElementById("verserror").style.display="inline"}var startPoint=new Date(base);var splitup=graph.split("!");var more=new Array();for(var i=0;i<splitup.length;i++){if(splitup[i]==""){continue}var element=new Array();element[0]=startPoint;element[1]=parseInt(splitup[i],10);if(element[1]<0){element[1]=null}more[i]=element;startPoint=startPoint.addMinutes(mConst().sampleIntervalMins)}var canvasOverlayConf={show:false,objects:[]};startPoint=new Date(base);for(var i=0;i<splitup.length;i++){if(splitup[i]==""){continue}if(parseInt(splitup[i],10)==-2){var ignoreOverlay={verticalLine:{name:"ignore",x:startPoint,lineWidth:5,yOffset:0,color:"rgb(230, 230, 230)",shadow:false}};canvasOverlayConf.show=true;canvasOverlayConf.objects.push(ignoreOverlay)}startPoint=startPoint.addMinutes(mConst().sampleIntervalMins)}if(smartOn){var fromstr=fixLen(fromhr)+fixLen(frommin);var tostr=fixLen(tohr)+fixLen(tomin);var smartStartPoint=new Date(base);var early=null;var late=null;var actual=null;for(var i=0;i<splitup.length;i++){var teststr1=smartStartPoint.format("hhmm");var smartStartPoint1=smartStartPoint;smartStartPoint=smartStartPoint.addMinutes(mConst().sampleIntervalMins);var teststr2=smartStartPoint.format("hhmm");if(early==null&&fromstr>=teststr1&&fromstr<=teststr2){early=smartStartPoint1}if(late==null&&tostr>=teststr1&&tostr<=teststr2){late=smartStartPoint1}if(actual==null&&goneoff!="N"&&goneoff>=teststr1&&goneoff<=teststr2){actual=smartStartPoint1}if(late!=null&&early!=null&&actual!=null){break}}if(early!=null&&late!=null){if(actual!=null){var canvasOverlayActual={verticalLine:{name:"actual",x:actual,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};canvasOverlayConf.show=true;canvasOverlayConf.objects.push(canvasOverlayActual)}var earlyOverlay={dashedVerticalLine:{name:"start",x:early,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(76, 217, 100)",shadow:false}};canvasOverlayConf.show=true;canvasOverlayConf.objects.push(earlyOverlay);var lateOverlay={dashedVerticalLine:{name:"end",x:late,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(255, 59, 48)",shadow:false}};canvasOverlayConf.show=true;canvasOverlayConf.objects.push(lateOverlay)}}var pieStartPoint=new Date(base);var points=0;var total=0;var awake=0;var deep=0;var light=0;var ignore=0;for(var i=0;i<splitup.length;i++){if(splitup[i]==""){continue}var data=parseInt(splitup[i],10);var teststr1=pieStartPoint.format("hhmm");var pieStartPoint1=pieStartPoint;pieStartPoint=pieStartPoint.addMinutes(mConst().sampleIntervalMins);var teststr2=pieStartPoint.format("hhmm");if(goneoff!="N"&&goneoff>=teststr1&&goneoff<=teststr2){break}if(data==-1){continue}if(data==-2){ignore++}else{if(data>mConst().awakeAbove){awake++}else{if(data>mConst().lightAbove){light++}else{deep++}}}}document.getElementById("ttotal").textContent=hrsmin((deep+light+awake+ignore)*mConst().sampleIntervalMins);document.getElementById("tawake").textContent=hrsmin(awake*mConst().sampleIntervalMins);document.getElementById("tlight").textContent=hrsmin(light*mConst().sampleIntervalMins);document.getElementById("tdeep").textContent=hrsmin(deep*mConst().sampleIntervalMins);document.getElementById("tignore").textContent=hrsmin(ignore*mConst().sampleIntervalMins);var data2=[["Awake?",awake],["Light",light],["Deep",deep],["Ignore",ignore]];$(document).ready(function(){var b=$.jqplot("chart1",[more],{grid:{background:"#ffffff"},animate:true,canvasOverlay:canvasOverlayConf,series:[{showMarker:false,breakOnNull:true,color:"rgb(0,122,255)",label:new Date(base).format("yyyy-MM-dd"),trendline:{show:true,color:"rgb(90,200,250)",label:"",type:"linear",shadow:true,lineWidth:1.5,shadowAngle:45,shadowOffset:1.5,shadowDepth:3,shadowAlpha:0.07}}],axesDefaults:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,showTicks:false,showTickMarks:false},legend:{show:true,location:"ne"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%R",angle:-30,fontSize:"8pt"},tickInterval:"1 hour",pad:0,showTicks:true,showTickMarks:true,min:new Date(base)},yaxis:{label:"Movement",min:-50,max:4000}}});var a=jQuery.jqplot("chart2",[data2],{grid:{background:"#ffffff"},seriesColors:["rgb(90, 200, 250)","rgb(0,122,255)","rgb(88,86,214)","rgb(130,130,130)"],seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{showDataLabels:true}},legend:{show:true,location:"e"}})});var timePoint=new Date(base);var body="&body=";var copyBody="";for(var i=0;i<splitup.length;i++){if(splitup[i]==""){continue}body=body+timePoint.format("hh:mm")+","+splitup[i]+"%0D%0A";copyBody=copyBody+timePoint.format("hh:mm")+","+splitup[i]+"\r\n";timePoint=timePoint.addMinutes(mConst().sampleIntervalMins)}if(smartOn){body=body+fromhr+":"+frommin+",START%0D%0A"+tohr+":"+tomin+",END%0D%0A";copyBody=copyBody+fromhr+":"+frommin+",START\r\n"+tohr+":"+tomin+",END\r\n";if(goneoff!="N"){var goneoffstr=goneoff.substr(0,2)+":"+goneoff.substr(2,2);body=body+goneoffstr+",ALARM%0D%0A";copyBody=copyBody+goneoffstr+",ALARM\r\n"}}var mailto="?subject=Morpheuz-"+new Date(base).format("yyyy-MM-dd")+".csv"+body;document.getElementById("mailtemp").value=mailto;document.getElementById("mail").href="mailto:"+emailto+mailto;document.getElementById("copy").value=copyBody;$("#copy").focus(function(){var a=$(this);a.select();a.mouseup(function(){a.unbind("mouseup");return false})});document.getElementById("emailto").onchange=function(){var b=document.getElementById("mailtemp").value;var a=document.getElementById("emailto").value;document.getElementById("mail").href="mailto:"+a+b};document.getElementById("reset").onclick=function(){var k=document.getElementById("smartalarm").checked?"Y":"N";var b=document.getElementById("inverse").checked?"Y":"N";var g=encodeURIComponent(document.getElementById("emailto").value);var d="";var j="";var c="";var h="";var e="";var f="";var a="";if(document.ios){h=getSelectedValue(document.getElementById("safromhour"));e=getSelectedValue(document.getElementById("safrommin"));f=getSelectedValue(document.getElementById("satohour"));a=getSelectedValue(document.getElementById("satomin"))}else{h=getTextValue(document.getElementById("safromhourtxt"),true);e=getTextValue(document.getElementById("safrommintxt"),false);f=getTextValue(document.getElementById("satohourtxt"),true);a=getTextValue(document.getElementById("satomintxt"),false);if(h=="X"||e=="X"||f=="X"||a=="X"){return}}if((h+":"+e)>=(f+":"+a)){document.getElementById("safromhour").style.backgroundColor="red";document.getElementById("safrommin").style.backgroundColor="red";document.getElementById("satohour").style.backgroundColor="red";document.getElementById("satomin").style.backgroundColor="red";document.getElementById("safromhourtxt").style.backgroundColor="red";document.getElementById("safrommintxt").style.backgroundColor="red";document.getElementById("satohourtxt").style.backgroundColor="red";document.getElementById("satomintxt").style.backgroundColor="red"}else{window.location.href="pebblejs://close#reset!"+k+"!"+h+"!"+e+"!"+f+"!"+a+"!"+b+"!"+g+"!"+d+"!"+j+"!"+c}};