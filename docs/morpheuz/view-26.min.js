function mConst(){var a={awakeAbove:1000,lightAbove:120,sampleIntervalMins:10,vers:25};return a}function buildGraphDataSet(e,f,c){var d=new Date(e);for(var b=0;b<f.length;b++){if(f[b]===""){continue}var a=new Array();a[0]=d;a[1]=parseInt(f[b],10);if(a[1]<0){a[1]=null}c[b]=a;d=d.addMinutes(mConst().sampleIntervalMins)}}function populateIgnore(d,b,f){var c=new Date(d);for(var a=0;a<f.length;a++){if(f[a]===""){continue}if(parseInt(f[a],10)==-2){var e={verticalLine:{name:"ignore",x:c,lineWidth:5,yOffset:0,color:"#184E99",shadow:false}};b.show=true;b.objects.push(e)}c=c.addMinutes(mConst().sampleIntervalMins)}}function returnAbsoluteMatch(e,b,c){var a=e;while(a.getTime()<b.getTime()){var d=a.format("hhmm");if(c===d){return a}a=a.addMinutes(1)}return e}function startStopAlarm(h,k,r,l,p,g,j,f){if(h){var q=fixLen(k)+fixLen(r);var o=fixLen(l)+fixLen(p);var s=new Date(g);var a=null;var c=null;for(var n=0;n<f.length;n++){var e=s.format("hhmm");var m=s;s=s.addMinutes(mConst().sampleIntervalMins);var d=s.format("hhmm");if(a===null&&q>=e&&q<=d){a=returnAbsoluteMatch(m,s,q)}if(c===null&&o>=e&&o<=d){c=returnAbsoluteMatch(m,s,o)}if(c!==null&&a!==null){break}}if(a!==null){var t={dashedVerticalLine:{name:"start",x:a,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(76, 217, 100)",shadow:false}};j.show=true;j.objects.push(t)}if(c!==null){var b={dashedVerticalLine:{name:"end",x:c,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(255, 59, 48)",shadow:false}};j.show=true;j.objects.push(b)}}}function calculateStats(g,f,m,s){var o=new Date(g);var t=true;var b=null;var w=null;var a=null;var l=null;var u=null;var p=null;for(var y=0;y<f.length;y++){if(f[y]===""){continue}var A=parseInt(f[y],10);var d=o.format("hhmm");var r=o;o=o.addMinutes(mConst().sampleIntervalMins);var c=o.format("hhmm");if(m!="N"&&m>=d&&m<=c){a=returnAbsoluteMatch(r,o,m);l=y;break}else{if(A!=-1&&A!=-2&&A<=mConst().awakeAbove){if(t){b=r;w=y;var k={verticalLine:{name:"begin",x:b,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};s.show=true;s.objects.push(k);t=false}u=o;p=y}}}if(a===null&&u!==null){a=u;l=p}var q=0;var x=0;var e=0;var z=0;for(var v=w;v<=l;v++){if(f[v]===""){continue}var h=parseInt(f[v],10);if(h==-1||h==-2){z++}else{if(h>mConst().awakeAbove){q++}else{if(h>mConst().lightAbove){e++}else{x++}}}}if(a!==null){var n={verticalLine:{name:"endstop",x:a,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};s.show=true;s.objects.push(n)}return{tbegin:b,tends:a,deep:x,light:e,awake:q,ignore:z}}function generateCopyLinkData(b,l,k,n,h,m,e,d){var c=new Date(b);var g="&body=";var a="";for(var f=0;f<l.length;f++){if(l[f]===""){continue}g=g+c.format("hh:mm")+","+l[f]+"%0D%0A";a=a+c.format("hh:mm")+","+l[f]+"\r\n";c=c.addMinutes(mConst().sampleIntervalMins)}if(k){g=g+n+":"+h+",START%0D%0A"+m+":"+e+",END%0D%0A";a=a+n+":"+h+",START\r\n"+m+":"+e+",END\r\n";if(d!="N"){var j=d.substr(0,2)+":"+d.substr(2,2);g=g+j+",ALARM%0D%0A";a=a+j+",ALARM\r\n"}}return{body:g,copyBody:a}}function getEl(a){return document.getElementById(a)}$("document").ready(function(){document.ios=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i);if(document.ios){$(".android").hide()}else{$(".ios").hide()}var p=getParameterByName("base");var h=new Date().valueOf();if(p!==""&&p!=="null"){h=parseInt(p,10)}var b=getParameterByName("graph");var r=getParameterByName("fromhr");var A=getParameterByName("frommin");var s=getParameterByName("tohr");var z=getParameterByName("tomin");var e=getParameterByName("smart");var y=getParameterByName("vers");var m=getParameterByName("goneoff");var f=decodeURIComponent(getParameterByName("emailto"));var u=decodeURIComponent(getParameterByName("potoken"));var g=decodeURIComponent(getParameterByName("pouser"));var a=decodeURIComponent(getParameterByName("postat"));var l=decodeURIComponent(getParameterByName("swpdo"));var c=decodeURIComponent(getParameterByName("swpstat"));var B=getParameterByName("noset");var n=getParameterByName("token");var o=e==="Y";var x=B==="Y";if(x){$(".noset").hide()}getEl("emailto").value=f;getEl("ptoken").value=u;getEl("puser").value=g;getEl("swpdo").checked=l==="Y";getEl("presult").textContent=a;getEl("swpstat").textContent=c;if(a==="OK"){$("#lipushover").addClass("green");$("#presult").addClass("green")}else{if(a===""||a===null||a==="Disabled"){$("#lipushover").addClass("blue");$("#presult").addClass("blue")}else{$("#lipushover").addClass("red");$("#presult").addClass("red")}}if(c==="OK"){$("#liswp").addClass("green");$("#swpstat").addClass("green")}else{if(c===""||c===null||c==="Disabled"){$("#liswp").addClass("blue");$("#swpstat").addClass("blue")}else{$("#liswp").addClass("red");$("#swpstat").addClass("red")}}getEl("version").textContent=parseInt(y,10)/10;if((new Date().valueOf())%10===0){getEl("info-message").style.display="block"}var d=b.split("!");var j=new Array();buildGraphDataSet(h,d,j);var q={show:false,objects:[]};populateIgnore(h,q,d);startStopAlarm(o,r,A,s,z,h,q,d);var w=calculateStats(h,d,m,q);getEl("ttotal").textContent=hrsmin((w.deep+w.light+w.awake+w.ignore)*mConst().sampleIntervalMins);getEl("tawake").textContent=hrsmin(w.awake*mConst().sampleIntervalMins);getEl("tlight").textContent=hrsmin(w.light*mConst().sampleIntervalMins);getEl("tdeep").textContent=hrsmin(w.deep*mConst().sampleIntervalMins);getEl("tignore").textContent=hrsmin(w.ignore*mConst().sampleIntervalMins);if(w.tbegin!==null&&w.tends!==null){getEl("tstarts").textContent=w.tbegin.format("dd N yyyy hh:mm");getEl("tends").textContent=w.tends.format("dd N yyyy hh:mm");var v="swpro2hk://?source=Morpheuz&starts="+w.tbegin.format("yyyy-MM-ddThh:mm:00")+"&ends="+w.tends.format("yyyy-MM-ddThh:mm:00");if(n!=null&&n!==""){v+="&at="+n}getEl("swp").href=v;if(!x){getEl("swp").onclick=function(){setTimeout(function(){window.location.href="pebblejs://close"},250)}}}else{$("#swp").hide()}getEl("swplink").onclick=function(){setTimeout(function(){window.location.href="pebblejs://close"},250)};var i=[["Awake?",w.awake],["Light",w.light],["Deep",w.deep],["Ignore",w.ignore]];$(document).ready(function(){var D=$.jqplot("chart1",[j],{grid:{background:"#2066C7",gridLineColor:"#1E75D7",borderColor:"#1E75D7",shadow:false},animate:true,canvasOverlay:q,series:[{showMarker:false,breakOnNull:true,color:"#40ADEB",label:new Date(h).format("yyyy-MM-dd"),shadow:false}],axesDefaults:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,showTicks:false,showTickMarks:false},legend:{show:false,location:"ne"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%R",angle:-30,fontSize:"8pt",textColor:"#40ADEB"},tickInterval:"1 hour",pad:0,showTicks:true,showTickMarks:true,min:new Date(h)},yaxis:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:"Movement",min:-50,max:4000,labelOptions:{textColor:"#1898FF"}}}});var C=jQuery.jqplot("chart2",[i],{grid:{background:"#FF7D48",borderColor:"#FF7D48",shadow:false},seriesColors:["#FFFF92","#FFA966","#FF3C31","rgb(130,130,130)"],seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{showDataLabels:true,shadow:false}},legend:{show:true,location:"e"}})});var k=generateCopyLinkData(h,d,o,r,A,s,z,m);var t="?subject=Morpheuz-"+new Date(h).format("yyyy-MM-dd")+".csv"+k.body;getEl("mailtemp").value=t;getEl("mail").href="mailto:"+f+t;getEl("copy").value=k.copyBody;if(!x){getEl("mail").onclick=function(){setTimeout(function(){window.location.href="pebblejs://close"},250)}}$("#copy").focus(function(){var C=$(this);C.select();C.mouseup(function(){C.unbind("mouseup");return false})});getEl("emailto").onchange=function(){var D=getEl("mailtemp").value;var C=getEl("emailto").value;getEl("mail").href="mailto:"+C+D};getEl("save").onclick=function(){var C="N";var H="";var F=encodeURIComponent(getEl("emailto").value);var D=encodeURIComponent(getEl("ptoken").value);var G=encodeURIComponent(getEl("puser").value);var E=getEl("swpdo").checked?"Y":"N";window.location.href="pebblejs://close#reset!"+C+"!"+H+"!"+H+"!"+H+"!"+H+"!"+C+"!"+F+"!"+G+"!"+H+"!"+D+"!"+C+"!"+E}});