function mConst(){var a={awakeAbove:1000,lightAbove:120,sampleIntervalMins:10,vers:23};return a}function buildGraphDataSet(e,f,c){var d=new Date(e);for(var b=0;b<f.length;b++){if(f[b]==""){continue}var a=new Array();a[0]=d;a[1]=parseInt(f[b],10);if(a[1]<0){a[1]=null}c[b]=a;d=d.addMinutes(mConst().sampleIntervalMins)}}function populateIgnore(d,b,f){var c=new Date(d);for(var a=0;a<f.length;a++){if(f[a]==""){continue}if(parseInt(f[a],10)==-2){var e={verticalLine:{name:"ignore",x:c,lineWidth:5,yOffset:0,color:"#184E99",shadow:false}};b.show=true;b.objects.push(e)}c=c.addMinutes(mConst().sampleIntervalMins)}}function startStopAlarm(j,m,u,o,s,g,k,h,f){if(j){var t=fixLen(m)+fixLen(u);var r=fixLen(o)+fixLen(s);var v=new Date(g);var a=null;var c=null;var n=null;for(var q=0;q<f.length;q++){var e=v.format("hhmm");var p=v;v=v.addMinutes(mConst().sampleIntervalMins);var d=v.format("hhmm");if(a==null&&t>=e&&t<=d){a=p}if(c==null&&r>=e&&r<=d){c=p}if(n==null&&h!="N"&&h>=e&&h<=d){n=p}if(c!=null&&a!=null&&n!=null){break}}if(a!=null&&c!=null){if(n!=null){var l={verticalLine:{name:"actual",x:n,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};k.show=true;k.objects.push(l)}var w={dashedVerticalLine:{name:"start",x:a,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(76, 217, 100)",shadow:false}};k.show=true;k.objects.push(w);var b={dashedVerticalLine:{name:"end",x:c,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(255, 59, 48)",shadow:false}};k.show=true;k.objects.push(b)}}}function calculateStats(g,e,j,o){var l=new Date(g);var r=0;var w=0;var m=0;var s=0;var f=0;var u=0;var p=true;var c=null;var a=null;var q=null;for(var t=0;t<e.length;t++){if(e[t]==""){continue}var v=parseInt(e[t],10);var d=l.format("hhmm");var n=l;l=l.addMinutes(mConst().sampleIntervalMins);var b=l.format("hhmm");if(j!="N"&&j>=d&&j<=b){a=l;break}else{if(v==-1){continue}else{if(v==-2){u++}else{if(v>mConst().awakeAbove){m++}else{if(p){c=l;var h={verticalLine:{name:"begin",x:c,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};o.show=true;o.objects.push(h);p=false}q=l;if(v>mConst().lightAbove){f++}else{s++}}}}}}if(a==null&&q!=null){var k={verticalLine:{name:"endstop",x:q,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};o.show=true;o.objects.push(k);a=q}return{tbegin:c,tends:a,deep:s,light:f,awake:m,ignore:u}}function generateCopyLinkData(b,l,k,n,h,m,e,d){var c=new Date(b);var g="&body=";var a="";for(var f=0;f<l.length;f++){if(l[f]==""){continue}g=g+c.format("hh:mm")+","+l[f]+"%0D%0A";a=a+c.format("hh:mm")+","+l[f]+"\r\n";c=c.addMinutes(mConst().sampleIntervalMins)}if(k){g=g+n+":"+h+",START%0D%0A"+m+":"+e+",END%0D%0A";a=a+n+":"+h+",START\r\n"+m+":"+e+",END\r\n";if(d!="N"){var j=d.substr(0,2)+":"+d.substr(2,2);g=g+j+",ALARM%0D%0A";a=a+j+",ALARM\r\n"}}return{body:g,copyBody:a}}function getEl(a){return document.getElementById(a)}document.ios=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i);if(document.ios){$(".android").hide()}else{$(".ios").hide()}var baseStr=getParameterByName("base");var base=new Date().valueOf();if(baseStr!=""&&baseStr!="null"){base=parseInt(baseStr,10)}var graph=getParameterByName("graph");var fromhr=getParameterByName("fromhr");var frommin=getParameterByName("frommin");var tohr=getParameterByName("tohr");var tomin=getParameterByName("tomin");var smart=getParameterByName("smart");var inverse=getParameterByName("inverse");var vers=getParameterByName("vers");var goneoff=getParameterByName("goneoff");var emailto=decodeURIComponent(getParameterByName("emailto"));var xuser=decodeURIComponent(getParameterByName("xuser"));var xpass=decodeURIComponent(getParameterByName("xpass"));var xkey=decodeURIComponent(getParameterByName("xkey"));var smartOn=smart=="Y";var inverseOn=inverse=="Y";getEl("emailto").value=emailto;getEl("smartalarm").checked=smartOn;getEl("inverse").checked=inverseOn;if(document.ios){setSelectedValue(getEl("safromhour"),fromhr);setSelectedValue(getEl("safrommin"),frommin);setSelectedValue(getEl("satohour"),tohr);setSelectedValue(getEl("satomin"),tomin)}else{setTextValue(getEl("safromhourtxt"),fromhr);setTextValue(getEl("safrommintxt"),frommin);setTextValue(getEl("satohourtxt"),tohr);setTextValue(getEl("satomintxt"),tomin)}getEl("version").textContent=parseInt(vers,10)/10;if(vers!=mConst().vers){getEl("verserror").style.display="inline"}var splitup=graph.split("!");var more=new Array();buildGraphDataSet(base,splitup,more);var canvasOverlayConf={show:false,objects:[]};populateIgnore(base,canvasOverlayConf,splitup);startStopAlarm(smartOn,fromhr,frommin,tohr,tomin,base,canvasOverlayConf,goneoff,splitup);var out=calculateStats(base,splitup,goneoff,canvasOverlayConf);getEl("ttotal").textContent=hrsmin((out.deep+out.light+out.awake+out.ignore)*mConst().sampleIntervalMins);getEl("tawake").textContent=hrsmin(out.awake*mConst().sampleIntervalMins);getEl("tlight").textContent=hrsmin(out.light*mConst().sampleIntervalMins);getEl("tdeep").textContent=hrsmin(out.deep*mConst().sampleIntervalMins);getEl("tignore").textContent=hrsmin(out.ignore*mConst().sampleIntervalMins);if(out.tbegin!=null&&out.tends!=null){getEl("tstarts").textContent=out.tbegin.format("dd N yyyy hh:mm");getEl("tends").textContent=out.tends.format("dd N yyyy hh:mm");getEl("swp").href="swpro2hk://?source=Morpheuz&starts="+out.tbegin.format("yyyy-MM-ddThh:mm:00")+"&ends="+out.tends.format("yyyy-MM-ddThh:mm:00");getEl("swp").onclick=function(){setTimeout(function(){window.location.href="pebblejs://close"},250)}}else{$("#swp").hide()}var data2=[["Awake?",out.awake],["Light",out.light],["Deep",out.deep],["Ignore",out.ignore]];$(document).ready(function(){var b=$.jqplot("chart1",[more],{grid:{background:"#2066C7",gridLineColor:"#1E75D7",borderColor:"#1E75D7",shadow:false},animate:true,canvasOverlay:canvasOverlayConf,series:[{showMarker:false,breakOnNull:true,color:"#40ADEB",label:new Date(base).format("yyyy-MM-dd"),shadow:false}],axesDefaults:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,showTicks:false,showTickMarks:false},legend:{show:false,location:"ne"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%R",angle:-30,fontSize:"8pt",textColor:"#1898FF"},tickInterval:"1 hour",pad:0,showTicks:true,showTickMarks:true,min:new Date(base)},yaxis:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:"Movement",min:-50,max:4000,labelOptions:{textColor:"#1898FF"}}}});var a=jQuery.jqplot("chart2",[data2],{grid:{background:"#FF7D48",borderColor:"#FF7D48",shadow:false},seriesColors:["#FFFF92","#FFA966","#FF3C31","rgb(130,130,130)"],seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{showDataLabels:true,shadow:false}},legend:{show:true,location:"e"}})});var cpy=generateCopyLinkData(base,splitup,smartOn,fromhr,frommin,tohr,tomin,goneoff);var mailto="?subject=Morpheuz-"+new Date(base).format("yyyy-MM-dd")+".csv"+cpy.body;getEl("mailtemp").value=mailto;getEl("mail").href="mailto:"+emailto+mailto;getEl("copy").value=cpy.copyBody;getEl("mail").onclick=function(){setTimeout(function(){window.location.href="pebblejs://close"},250)};$("#copy").focus(function(){var a=$(this);a.select();a.mouseup(function(){a.unbind("mouseup");return false})});getEl("emailto").onchange=function(){var b=getEl("mailtemp").value;var a=getEl("emailto").value;getEl("mail").href="mailto:"+a+b};getEl("reset").onclick=function(){var k=getEl("smartalarm").checked?"Y":"N";var b=getEl("inverse").checked?"Y":"N";var h=encodeURIComponent(getEl("emailto").value);var d="";var j="";var c="";var i="";var e="";var g="";var a="";if(document.ios){i=getSelectedValue(getEl("safromhour"));e=getSelectedValue(getEl("safrommin"));g=getSelectedValue(getEl("satohour"));a=getSelectedValue(getEl("satomin"))}else{i=getTextValue(getEl("safromhourtxt"),true);e=getTextValue(getEl("safrommintxt"),false);g=getTextValue(getEl("satohourtxt"),true);a=getTextValue(getEl("satomintxt"),false);if(i=="X"||e=="X"||g=="X"||a=="X"){return}}function f(l){getEl(l).style.backgroundColor="red"}if((i+":"+e)>=(g+":"+a)){f("safromhour");f("safrommin");f("satohour");f("satomin");f("safromhourtxt");f("safrommintxt");f("satohourtxt");f("satomintxt")}else{window.location.href="pebblejs://close#reset!"+k+"!"+i+"!"+e+"!"+g+"!"+a+"!"+b+"!"+h+"!"+d+"!"+j+"!"+c}};