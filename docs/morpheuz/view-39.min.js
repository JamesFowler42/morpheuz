function mConst(){return{chartBottom:-50,chartTop:4000,swpAppStoreUrl:"https://itunes.apple.com/app/smartwatch-pro-for-pebble/id673907094?mt=8&at=10lIFm&pt=409665&ct=morpheuz_web",displayDateFmt:"WWW, NNN dd, yyyy hh:mm",iosDateFormat:"dd N yyyy hh:mm",swpUrlDate:"yyyy-MM-ddThh:mm:00",emailHeader:"<h2>CSV Sleep data</h2>",emailHeader2:"<h2>Chart Display</h2>",emailFooter1:"<br/>Note: -1 is no data captured, -2 is ignore set, ALARM, START and END nodes represent smart alarm actual, start and end",emailFooter2:"<br/><br/><small>Please don't reply, this is an unmonitored mailbox</small><br/>",emailAddressMandatory:"valid email address is required",sendingEmail:"Sending...",url:"http://ui.morpheuz.net/keith.j.fowler/morpheuz/view-",report:"Report"}}function buildGraphDataSet(e,f,c){var d=new Date(e);for(var b=0;b<f.length;b++){if(f[b]===""){continue}var a=new Array();a[0]=d;a[1]=parseInt(f[b],10);if(a[1]<0){a[1]=null}c[b]=a;d=d.addMinutes(mCommonConst().sampleIntervalMins)}}function populateIgnore(f,c,h,a){var e=a/h.length;var d=new Date(f);for(var b=0;b<h.length;b++){if(h[b]===""){continue}if(parseInt(h[b],10)==-2){var g={verticalLine:{name:"ignore",x:d,lineWidth:e,yOffset:0,color:"#184E99",shadow:false}};c.show=true;c.objects.push(g)}d=d.addMinutes(mCommonConst().sampleIntervalMins)}}function startStopAlarm(h,k,r,l,p,g,j,f){if(h){var q=fixLen(k)+fixLen(r);var o=fixLen(l)+fixLen(p);var s=new Date(g);var a=null;var c=null;for(var n=0;n<f.length;n++){var e=s.format("hhmm");var m=s;s=s.addMinutes(mCommonConst().sampleIntervalMins);var d=s.format("hhmm");if(a===null&&q>=e&&q<=d){a=returnAbsoluteMatch(m,s,q)}if(c===null&&o>=e&&o<=d){c=returnAbsoluteMatch(m,s,o)}if(c!==null&&a!==null){break}}if(a!==null){var t={dashedVerticalLine:{name:"start",x:a,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(76, 217, 100)",shadow:false}};j.show=true;j.objects.push(t)}if(c!==null){var b={dashedVerticalLine:{name:"end",x:c,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(255, 59, 48)",shadow:false}};j.show=true;j.objects.push(b)}}}function calculateStatsPlusCanvas(d,g,f,b){var a=calculateStats(d,g,f);if(a&&a.tbegin){var e={verticalLine:{name:"begin",x:a.tbegin,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};b.show=true;b.objects.push(e)}if(a&&a.tends){var c={verticalLine:{name:"endstop",x:a.tends,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};b.show=true;b.objects.push(c)}return a}$("document").ready(function(){adjustForViewport();document.ios=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i);if(document.ios){$(".android").hide()}else{$(".ios").hide()}var z=getParameterByName("base");var n=new Date().valueOf();if(z!==""&&z!=="null"){n=parseInt(z,10)}var E=getParameterByName("graph");var g=getParameterByName("fromhr");var m=getParameterByName("frommin");var B=getParameterByName("tohr");var G=getParameterByName("tomin");var A=getParameterByName("smart");var k=getParameterByName("vers");var D=getParameterByName("goneoff");var v=decodeURIComponent(getParameterByName("emailto"));var K=decodeURIComponent(getParameterByName("potoken"));var N=decodeURIComponent(getParameterByName("pouser"));var j=decodeURIComponent(getParameterByName("postat"));var y=decodeURIComponent(getParameterByName("swpdo"));var t=decodeURIComponent(getParameterByName("lifxtoken"));var f=decodeURIComponent(getParameterByName("lifxtime"));var M=decodeURIComponent(getParameterByName("swpstat"));var L=getParameterByName("noset");var i=getParameterByName("token");var l=decodeURIComponent(getParameterByName("exptime"));var h=getParameterByName("usage");var c=getParameterByName("lazarus");var q=getParameterByName("hueip");var p=getParameterByName("hueuser");var w=getParameterByName("hueid");var u=decodeURIComponent(getParameterByName("ifkey"));var b=decodeURIComponent(getParameterByName("ifserver"));var e=decodeURIComponent(getParameterByName("ifstat"));var a=getParameterByName("age");var s=getParameterByName("return_to");if(s===""){s="pebblejs://close#"}var r=A==="Y";var d=L==="Y";if(d){$(".noset").hide()}$("#emailto").val(v);$("#ptoken").val(K);$("#puser").val(N);$("#lifxToken").val(t);$("#lifxTime").val(f);$("#swpdo").prop("checked",y==="Y");$("#presult").text(j);$("#swpstat").text(M);$("#exptime").text(l);$("#usage").prop("checked",h!=="N");$("#hueip").val(q);$("#hueuser").val(p);$("#hueid").val(w);$("#lazarus").prop("checked",c!=="N");$("#ifkey").val(u);$("#ifserver").val(b);$("#ifstat").text(e);$("#age").val(a);if(j==="OK"){$("#lipushover").addClass("green");$("#presult").addClass("green")}else{if(j===""||j===null||j==="Disabled"){$("#lipushover").addClass("blue");$("#presult").addClass("blue")}else{$("#lipushover").addClass("red");$("#presult").addClass("red")}}if(M==="OK"){$("#liswp").addClass("green");$("#swpstat").addClass("green")}else{if(M===""||M===null||M==="Disabled"){$("#liswp").addClass("blue");$("#swpstat").addClass("blue")}else{$("#liswp").addClass("red");$("#swpstat").addClass("red")}}if(t===""){$("#lilifx").addClass("blue")}else{$("#lilifx").addClass("green")}if(q===""){$("#lihue").addClass("blue")}else{$("#lihue").addClass("green")}if(h!=="N"){$("#liusage").addClass("green")}else{$("#liusage").addClass("blue")}if(c!=="N"){$("#lilazarus").addClass("green")}else{$("#lilazarus").addClass("blue")}if(e==="OK"){$("#liif").addClass("green");$("#ifstat").addClass("green")}else{if(e===""||e===null||e==="Disabled"){$("#liif").addClass("blue");$("#ifstat").addClass("blue")}else{$("#liif").addClass("red");$("#ifstat").addClass("red")}}$("li.red").removeClass("liclosed").addClass("liopen");$("#version").text(parseInt(k,10)/10);$("#sleep-time").text(new Date(n).format(mConst().displayDateFmt));if((new Date().valueOf())%10===0){$("#info-message").css("display","block")}$(".licollapse > p").click(function(){if($(this).parent().hasClass("liopen")){$(this).parent().removeClass("liopen").addClass("liclosed")}else{$(this).parent().removeClass("liclosed").addClass("liopen")}});if(!d){setScreenMessageBasedOnVersion(k)}var J=E.split("!");var C=new Array();buildGraphDataSet(n,J,C);var o={show:false,objects:[]};populateIgnore(n,o,J,$("#chart1").width());startStopAlarm(r,g,m,B,G,n,o,J);var F=calculateStatsPlusCanvas(n,D,J,o);var H=buildRecommendationPhrase(a,F);$("#stats").text(H.summary);$("#ttotal").text(H.total);$("#tawake").text(H.awake);$("#tlight").text(H.light);$("#tdeep").text(H.deep);$("#tignore").text(H.ignore);if(F.tbegin!==null&&F.tends!==null){$("#swpnodata").hide();$("#tstarts").text(F.tbegin.format(mConst().iosDateFormat));$("#tends").text(F.tends.format(mConst().iosDateFormat));var x="swpro2hk://?source=Morpheuz&starts="+F.tbegin.format(mConst().swpUrlDate)+"&ends="+F.tends.format(mConst().swpUrlDate);if(i!=null&&i!==""){x+="&at="+i}$("#swp").prop("href",x);if(!d){$("#swp").click(function(){setTimeout(function(){window.location.href="pebblejs://close"},250)})}}else{$("#swp").hide()}$("#swplink").prop("href",mConst().swpAppStoreUrl);$("#swplink").click(function(){setTimeout(function(){window.location.href="pebblejs://close"},250)});var I=[["Restless",F.awake],["Light",F.light],["Deep",F.deep],["Ignore",F.ignore]];$(document).ready(function(){document.plot1=$.jqplot("chart1",[C],{grid:{background:"#2066C7",gridLineColor:"#1E75D7",borderColor:"#1E75D7",shadow:false},animate:true,canvasOverlay:o,series:[{showMarker:false,breakOnNull:true,color:"#40ADEB",label:new Date(n).format("yyyy-MM-dd"),shadow:false}],axesDefaults:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,showTicks:false,showTickMarks:false},legend:{show:false,location:"ne"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%R",angle:-30,fontSize:"8pt",textColor:"#40ADEB"},tickInterval:"1 hour",pad:0,showTicks:true,showTickMarks:true,min:new Date(n)},yaxis:{ticks:[mConst().chartBottom,mThres().lightAbove,mThres().awakeAbove,mConst().chartTop],labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:"Movement",min:mConst().chartBottom,max:mConst().chartTop,labelOptions:{textColor:"#1898FF"}}}});document.plot2=jQuery.jqplot("chart2",[I],{grid:{background:"#FF7D48",borderColor:"#FF7D48",shadow:false},seriesColors:["#FFFF92","#FFA966","#FF3C31","rgb(130,130,130)"],seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{showDataLabels:true,shadow:false}},legend:{show:true,location:"e"}})});$(".save").click(function(){var O={action:"save",emailto:safeTrim($("#emailto").val()),pouser:safeTrim($("#puser").val()),potoken:safeTrim($("#ptoken").val()),swpdo:$("#swpdo").is(":checked")?"Y":"N",usage:$("#usage").is(":checked")?"Y":"N",lifxtoken:safeTrim($("#lifxToken").val()),lifxtime:safeTrim($("#lifxTime").val()),hueip:safeTrim($("#hueip").val()),hueuser:safeTrim($("#hueuser").val()),hueid:safeTrim($("#hueid").val()),lazarus:$("#lazarus").is(":checked")?"Y":"N",testsettings:$("#testsettings").is(":checked")?"Y":"N",ifkey:safeTrim($("#ifkey").val()),ifserver:safeTrim($("#ifserver").val()),age:safeTrim($("#age").val())};document.location=s+encodeURIComponent(JSON.stringify(O))});$("#mail").removeAttr("disabled");$("#mail").click(function(){var O=$("#emailto").val();if(O===""||!validateEmail(O)){$("#emailSendResult").text(mConst().emailAddressMandatory);$("#emailSendResult").addClass("red");return}var R=generateCopyLinkData(n,J,r,g,m,B,G,D);var Q="<a href='"+mConst().url+k+".html?base="+n+"&graph="+E+"&fromhr="+g+"&tohr="+B+"&frommin="+m+"&tomin="+G+"&smart="+A+"&vers="+k+"&goneoff="+D+"&token="+i+"&age="+a+"&emailto="+encodeURIComponent(O)+"&noset=Y'>"+mConst().report+"</a><br/>";var P={from:"Morpheuz <noreply@morpheuz.co.uk>",to:O,subject:"Morpheuz-"+new Date(n).format("yyyy-MM-dd"),message:mConst().emailHeader2+Q+mConst().emailHeader+R.body+mConst().emailFooter1+mConst().emailFooter2};$("#mail").attr("disabled","disabled");$("#emailSendResult").removeClass("red").removeClass("green");$("#emailSendResult").text(mConst().sendingEmail);sendMailViaServer(P,function(S,T){if(S===1){$("#emailSendResult").addClass("green")}else{$("#emailSendResult").addClass("red")}$("#emailSendResult").text(T);$("#mail").removeAttr("disabled")})});$("#age").keyup(function(){var O=$("#age").val();$("#stats").text(buildRecommendationPhrase(O,F).summary)});$("#lesssummary").click(function(){$("#summarytable").hide();$("#lesssummary").hide();$("#moresummary").show();if(window.localStorage){window.localStorage.setItem("lesssummary","true")}});$("#moresummary").click(function(){$("#summarytable").show();$("#moresummary").hide();$("#lesssummary").show();if(window.localStorage){window.localStorage.setItem("lesssummary","false")}});if(window.localStorage&&window.localStorage.getItem("lesssummary")==="true"){$("#summarytable").hide();$("#lesssummary").hide();$("#moresummary").show()}});function mUtil(){return{emailUrl:"json_email.php",emailToken:"morpheuz20",okResponse:"Sent OK",failResponse:"Failed to send with ",failGeneral:"Failed to send"}}function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var c=new RegExp("[\\?&]"+a+"=([^&#]*)"),b=c.exec(location.search);return b==null?"":decodeURIComponent(b[1].replace(/\+/g," "))}function setScreenMessageBasedOnVersion(a){$(".versproblem").show();$.ajaxSetup({scriptCharset:"utf-8",contentType:"application/json; charset=utf-8"});$.getJSON("currentversion.json?v="+new Date().getTime(),function(d){if(typeof d!=="undefined"&&typeof d.version!=="undefined"){var c=parseInt(d.version,10);var b=parseInt(a,10);$(".versproblem").hide();if(c>b){$(".verswarning").show()}else{if(c<b){$(".versbeta").show()}}}}).error(function(b){$(".versproblem").text("Error attempting to find the current version: "+JSON.stringify(b))})}function scaleToViewport(){var a=$(window).width();if(a>800){a=800}else{if(a<320){a=320}}a-=5;$(".vpwidth").width(a);$(".vpheight").height(a*250/318);if(typeof document.plot1!=="undefined"){document.plot1.replot()}if(typeof document.plot2!=="undefined"){document.plot2.replot()}}function adjustForViewport(){scaleToViewport();$(window).resize(scaleToViewport)}function sendMailViaServer(a,e){try{var d="email="+encodeURIComponent(JSON.stringify(a));var c=new XMLHttpRequest();c.open("POST",mUtil().emailUrl,true);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.setRequestHeader("X-Client-token",mUtil().emailToken);c.onreadystatechange=function(f){if(c.readyState==4){if(c.status==200){e(1,mUtil().okResponse)}else{e(0,mUtil().failResponse+c.status)}}};c.onerror=function(f){e(0,mUtil().failGeneral)};c.send(d)}catch(b){e(0,mUtil().failResponse+b.message)}}function validateEmail(a){var b=/[^\s@]+@[^\s@]+\.[^\s@]+/;return b.test(a)}function safeTrim(b){try{return b.trim()}catch(a){return b}}function mCommonConst(){return{sampleIntervalMins:10}}function mCommonLang(){return{noSleep:"No sleep has been recorded yet. If this is incorrect, select the 'Resend' menu option on your watch and check again in a few minutes.",sleepSummary:"Your body and brain requires {0} to {1} hours sleep every night. Last night was {2} as you slept for {3}. Of that sleep: {4} was restless; {5} was light; {6} was deep; {7} was excluded as it either wasn't recorded, or you marked it to be ignored.",sleepSummaryNoRecommend:"You slept for {0}. Of that sleep: {1} was restless; {2} was light; {3} was deep; {4} was excluded as it either wasn't recorded, or you marked it to be ignored.",minutes:" minutes",minute:" minute",hour:" hour",hours:" hours",none:"none",tooLittle:"too little",tooMuch:"too much",ideal:"ideal"}}function mThres(){return{awakeAbove:1000,lightAbove:120}}Date.prototype.format=function(d){var b=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];var a=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];var e={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"i+":this.getHours()+1,"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(d)){d=d.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var c in e){if(new RegExp("("+c+")").test(d)){d=d.replace(RegExp.$1,RegExp.$1.length==1?e[c]:("00"+e[c]).substr((""+e[c]).length))}}if(/(N+)/.test(d)){d=d.replace(RegExp.$1,b[this.getMonth()])}if(/(W+)/.test(d)){d=d.replace(RegExp.$1,a[this.getDay()])}return d};Date.prototype.addMinutes=function(b){var a=new Date(this.getTime());return new Date(a.getTime()+b*60000)};String.prototype.format=function(){var c=this;for(var a=0;a<arguments.length;a++){var b="{"+a+"}";c=c.replace(b,arguments[a])}return c};function nvl(b,a){return b===null||b==="null"||typeof b==="undefined"?a:b}function fixLen(a){if(a===null||a.length>1){return a}return"0"+a}function hrsmin(d){if(d===0){return mCommonLang().none}var a="";var b=Math.floor(d/60);if(b==1){a+=b+mCommonLang().hour}else{if(b>1){a+=b+mCommonLang().hours}}var c=d%60;if(c!==0){if(b===0){if(c===1){a+=fixLen(String(c))+mCommonLang().minute}else{a+=fixLen(String(c))+mCommonLang().minutes}}else{a+=" "+fixLen(String(c))}}return a}function getUserAgent(){if(typeof navigator==="undefined"||typeof navigator.userAgent==="undefined"){return"unknown"}else{return(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i))?"iOS":"Android"}}function calculateStats(h,m,g){var b=new Date(h);var r=true;var c=null;var a=null;var s=null;var u=null;var l=null;var n=null;for(var w=0;w<g.length;w++){if(g[w]===""){continue}var y=parseInt(g[w],10);var e=b.format("hhmm");var q=b;b=b.addMinutes(mCommonConst().sampleIntervalMins);var d=b.format("hhmm");if(m!="N"&&m>=e&&m<=d){a=returnAbsoluteMatch(q,b,m);l=w;break}else{if(y!=-1&&y!=-2&&y<=mThres().awakeAbove){if(r){c=q;u=w;r=false}s=b;n=w}}}if(a===null&&s!==null){a=s;l=n}var o=0;var v=0;var f=0;var x=0;if(u!==null&&l!==null){for(var t=u;t<=l;t++){if(g[t]===""){continue}var k=parseInt(g[t],10);if(k==-1||k==-2){x++}else{if(k>mThres().awakeAbove){o++}else{if(k>mThres().lightAbove){f++}else{v++}}}}}var p=a-c;var z=Math.round((p/1000)/60);return{tbegin:c,tends:a,deep:v*mCommonConst().sampleIntervalMins,light:f*mCommonConst().sampleIntervalMins,awake:o*mCommonConst().sampleIntervalMins,ignore:x*mCommonConst().sampleIntervalMins,total:z}}function returnAbsoluteMatch(e,b,c){var a=e;while(a.getTime()<b.getTime()){var d=a.format("hhmm");if(c===d){return a}a=a.addMinutes(1)}return e}function generateRecommendation(d,f){if(isNaN(d)){return null}var c=parseInt(d,10);if(isNaN(c)){return null}var e=0;var a=0;if(c<1){return"-"}else{if(c<3){e=11;a=14}else{if(c<6){e=10;a=13}else{if(c<14){e=9;a=11}else{if(c<18){e=8;a=10}else{if(c<64){e=7;a=9}else{e=7;a=8}}}}}}var g=Math.floor(f/60);var b="";if(g<e){b=mCommonLang().tooLittle}else{if(g>a){b=mCommonLang().tooMuch}else{b=mCommonLang().ideal}}return{min:e,max:a,view:b}}function buildRecommendationPhrase(h,f){if(f.total===0){return{summary:mCommonLang().noSleep,total:"-",awake:"-",light:"-",deep:"-",ignore:"-"}}var d=generateRecommendation(h,f.total);var c=hrsmin(f.total);var a=hrsmin(f.awake);var g=hrsmin(f.light);var i=hrsmin(f.deep);var e=hrsmin(f.ignore);var b;if(d!==null){b=mCommonLang().sleepSummary.format(d.min,d.max,d.view,c,a,g,i,e)}else{b=mCommonLang().sleepSummaryNoRecommend.format(c,a,g,i,e)}return{summary:b,total:c,awake:a,light:g,deep:i,ignore:e}}function generateCopyLinkData(a,k,j,m,g,l,d,c){var b=new Date(a);var f="<pre>";for(var e=0;e<k.length;e++){if(k[e]===""){continue}f=f+b.format("hh:mm")+","+k[e]+"<br/>";b=b.addMinutes(mCommonConst().sampleIntervalMins)}if(j){f=f+m+":"+g+",START<br/>"+l+":"+d+",END<br/>";if(c!="N"){var h=c.substr(0,2)+":"+c.substr(2,2);f=f+h+",ALARM<br/>"}}return{body:f+"</pre>"}};