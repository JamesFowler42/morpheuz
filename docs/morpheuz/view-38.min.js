function mConst(){return{chartBottom:-50,chartTop:4000,swpAppStoreUrl:"https://itunes.apple.com/app/smartwatch-pro-for-pebble/id673907094?mt=8&at=10lIFm&pt=409665&ct=morpheuz_web",displayDateFmt:"WWW, NNN dd, yyyy hh:mm",iosDateFormat:"dd N yyyy hh:mm",swpUrlDate:"yyyy-MM-ddThh:mm:00",emailHeader:"<h2>CSV Sleep data</h2>",emailHeader2:"<h2>Chart Display</h2>",emailFooter1:"<br/>Note: -1 is no data captured, -2 is ignore set, ALARM, START and END nodes represent smart alarm actual, start and end",emailFooter2:"<br/><br/><small>Please don't reply, this is an unmonitored mailbox</small><br/>",emailAddressMandatory:"valid email address is required",sendingEmail:"Sending...",url:"http://ui.morpheuz.net/keith.j.fowler/morpheuz/view-",report:"Report"}}function buildGraphDataSet(e,f,c){var d=new Date(e);for(var b=0;b<f.length;b++){if(f[b]===""){continue}var a=new Array();a[0]=d;a[1]=parseInt(f[b],10);if(a[1]<0){a[1]=null}c[b]=a;d=d.addMinutes(mCommonConst().sampleIntervalMins)}}function populateIgnore(f,c,h,a){var e=a/h.length;var d=new Date(f);for(var b=0;b<h.length;b++){if(h[b]===""){continue}if(parseInt(h[b],10)==-2){var g={verticalLine:{name:"ignore",x:d,lineWidth:e,yOffset:0,color:"#184E99",shadow:false}};c.show=true;c.objects.push(g)}d=d.addMinutes(mCommonConst().sampleIntervalMins)}}function startStopAlarm(h,k,r,l,p,g,j,f){if(h){var q=fixLen(k)+fixLen(r);var o=fixLen(l)+fixLen(p);var s=new Date(g);var a=null;var c=null;for(var n=0;n<f.length;n++){var e=s.format("hhmm");var m=s;s=s.addMinutes(mCommonConst().sampleIntervalMins);var d=s.format("hhmm");if(a===null&&q>=e&&q<=d){a=returnAbsoluteMatch(m,s,q)}if(c===null&&o>=e&&o<=d){c=returnAbsoluteMatch(m,s,o)}if(c!==null&&a!==null){break}}if(a!==null){var t={dashedVerticalLine:{name:"start",x:a,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(76, 217, 100)",shadow:false}};j.show=true;j.objects.push(t)}if(c!==null){var b={dashedVerticalLine:{name:"end",x:c,lineWidth:1,yOffset:0,dashPattern:[1,4],color:"rgb(255, 59, 48)",shadow:false}};j.show=true;j.objects.push(b)}}}function calculateStatsPlusCanvas(d,g,f,b){var a=calculateStats(d,g,f);if(a&&a.tbegin){var e={verticalLine:{name:"begin",x:a.tbegin,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};b.show=true;b.objects.push(e)}if(a&&a.tends){var c={verticalLine:{name:"endstop",x:a.tends,lineWidth:1,yOffset:0,color:"rgb(255, 149, 0)",shadow:false}};b.show=true;b.objects.push(c)}return a}$("document").ready(function(){adjustForViewport();document.ios=navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i);if(document.ios){$(".android").hide()}else{$(".ios").hide()}var z=getParameterByName("base");var n=new Date().valueOf();if(z!==""&&z!=="null"){n=parseInt(z,10)}var E=getParameterByName("graph");var g=getParameterByName("fromhr");var m=getParameterByName("frommin");var B=getParameterByName("tohr");var G=getParameterByName("tomin");var A=getParameterByName("smart");var k=getParameterByName("vers");var D=getParameterByName("goneoff");var v=decodeURIComponent(getParameterByName("emailto"));var J=decodeURIComponent(getParameterByName("potoken"));var M=decodeURIComponent(getParameterByName("pouser"));var j=decodeURIComponent(getParameterByName("postat"));var y=decodeURIComponent(getParameterByName("swpdo"));var t=decodeURIComponent(getParameterByName("lifxtoken"));var f=decodeURIComponent(getParameterByName("lifxtime"));var L=decodeURIComponent(getParameterByName("swpstat"));var K=getParameterByName("noset");var i=getParameterByName("token");var l=decodeURIComponent(getParameterByName("exptime"));var h=getParameterByName("usage");var c=getParameterByName("lazarus");var q=getParameterByName("hueip");var p=getParameterByName("hueuser");var w=getParameterByName("hueid");var u=decodeURIComponent(getParameterByName("ifkey"));var b=decodeURIComponent(getParameterByName("ifserver"));var e=decodeURIComponent(getParameterByName("ifstat"));var a=getParameterByName("age");var s=getParameterByName("return_to");if(s===""){s="pebblejs://close#"}var r=A==="Y";var d=K==="Y";if(d){$(".noset").hide()}$("#emailto").val(v);$("#ptoken").val(J);$("#puser").val(M);$("#lifxToken").val(t);$("#lifxTime").val(f);$("#swpdo").prop("checked",y==="Y");$("#presult").text(j);$("#swpstat").text(L);$("#exptime").text(l);$("#usage").prop("checked",h!=="N");$("#hueip").val(q);$("#hueuser").val(p);$("#hueid").val(w);$("#lazarus").prop("checked",c!=="N");$("#ifkey").val(u);$("#ifserver").val(b);$("#ifstat").text(e);$("#age").val(a);if(j==="OK"){$("#lipushover").addClass("green");$("#presult").addClass("green")}else{if(j===""||j===null||j==="Disabled"){$("#lipushover").addClass("blue");$("#presult").addClass("blue")}else{$("#lipushover").addClass("red");$("#presult").addClass("red")}}if(L==="OK"){$("#liswp").addClass("green");$("#swpstat").addClass("green")}else{if(L===""||L===null||L==="Disabled"){$("#liswp").addClass("blue");$("#swpstat").addClass("blue")}else{$("#liswp").addClass("red");$("#swpstat").addClass("red")}}if(t===""){$("#lilifx").addClass("blue")}else{$("#lilifx").addClass("green")}if(q===""){$("#lihue").addClass("blue")}else{$("#lihue").addClass("green")}if(h!=="N"){$("#liusage").addClass("green")}else{$("#liusage").addClass("blue")}if(c!=="N"){$("#lilazarus").addClass("green")}else{$("#lilazarus").addClass("blue")}if(e==="OK"){$("#liif").addClass("green");$("#ifstat").addClass("green")}else{if(e===""||e===null||e==="Disabled"){$("#liif").addClass("blue");$("#ifstat").addClass("blue")}else{$("#liif").addClass("red");$("#ifstat").addClass("red")}}$("li.red").removeClass("liclosed").addClass("liopen");$("#version").text(parseInt(k,10)/10);$("#sleep-time").text(new Date(n).format(mConst().displayDateFmt));if((new Date().valueOf())%10===0){$("#info-message").css("display","block")}$(".licollapse > p").click(function(){if($(this).parent().hasClass("liopen")){$(this).parent().removeClass("liopen").addClass("liclosed")}else{$(this).parent().removeClass("liclosed").addClass("liopen")}});if(!d){setScreenMessageBasedOnVersion(k)}var I=E.split("!");var C=new Array();buildGraphDataSet(n,I,C);var o={show:false,objects:[]};populateIgnore(n,o,I,$("#chart1").width());startStopAlarm(r,g,m,B,G,n,o,I);var F=calculateStatsPlusCanvas(n,D,I,o);$("#stats").text(buildRecommendationPhrase(a,F));if(F.tbegin!==null&&F.tends!==null){$("#swpnodata").hide();$("#tstarts").text(F.tbegin.format(mConst().iosDateFormat));$("#tends").text(F.tends.format(mConst().iosDateFormat));var x="swpro2hk://?source=Morpheuz&starts="+F.tbegin.format(mConst().swpUrlDate)+"&ends="+F.tends.format(mConst().swpUrlDate);if(i!=null&&i!==""){x+="&at="+i}$("#swp").prop("href",x);if(!d){$("#swp").click(function(){setTimeout(function(){window.location.href="pebblejs://close"},250)})}}else{$("#swp").hide()}$("#swplink").prop("href",mConst().swpAppStoreUrl);$("#swplink").click(function(){setTimeout(function(){window.location.href="pebblejs://close"},250)});var H=[["Restless",F.awake],["Light",F.light],["Deep",F.deep],["Ignore",F.ignore]];$(document).ready(function(){document.plot1=$.jqplot("chart1",[C],{grid:{background:"#2066C7",gridLineColor:"#1E75D7",borderColor:"#1E75D7",shadow:false},animate:true,canvasOverlay:o,series:[{showMarker:false,breakOnNull:true,color:"#40ADEB",label:new Date(n).format("yyyy-MM-dd"),shadow:false}],axesDefaults:{labelRenderer:$.jqplot.CanvasAxisLabelRenderer,showTicks:false,showTickMarks:false},legend:{show:false,location:"ne"},axes:{xaxis:{renderer:$.jqplot.DateAxisRenderer,tickRenderer:$.jqplot.CanvasAxisTickRenderer,tickOptions:{formatString:"%R",angle:-30,fontSize:"8pt",textColor:"#40ADEB"},tickInterval:"1 hour",pad:0,showTicks:true,showTickMarks:true,min:new Date(n)},yaxis:{ticks:[mConst().chartBottom,mThres().lightAbove,mThres().awakeAbove,mConst().chartTop],labelRenderer:$.jqplot.CanvasAxisLabelRenderer,label:"Movement",min:mConst().chartBottom,max:mConst().chartTop,labelOptions:{textColor:"#1898FF"}}}});document.plot2=jQuery.jqplot("chart2",[H],{grid:{background:"#FF7D48",borderColor:"#FF7D48",shadow:false},seriesColors:["#FFFF92","#FFA966","#FF3C31","rgb(130,130,130)"],seriesDefaults:{renderer:jQuery.jqplot.PieRenderer,rendererOptions:{showDataLabels:true,shadow:false}},legend:{show:true,location:"e"}})});$(".save").click(function(){var N={action:"save",emailto:safeTrim($("#emailto").val()),pouser:safeTrim($("#puser").val()),potoken:safeTrim($("#ptoken").val()),swpdo:$("#swpdo").is(":checked")?"Y":"N",usage:$("#usage").is(":checked")?"Y":"N",lifxtoken:safeTrim($("#lifxToken").val()),lifxtime:safeTrim($("#lifxTime").val()),hueip:safeTrim($("#hueip").val()),hueuser:safeTrim($("#hueuser").val()),hueid:safeTrim($("#hueid").val()),lazarus:$("#lazarus").is(":checked")?"Y":"N",testsettings:$("#testsettings").is(":checked")?"Y":"N",ifkey:safeTrim($("#ifkey").val()),ifserver:safeTrim($("#ifserver").val()),age:safeTrim($("#age").val())};document.location=s+encodeURIComponent(JSON.stringify(N))});$("#mail").removeAttr("disabled");$("#mail").click(function(){var N=$("#emailto").val();if(N===""||!validateEmail(N)){$("#emailSendResult").text(mConst().emailAddressMandatory);$("#emailSendResult").addClass("red");return}var Q=generateCopyLinkData(n,I,r,g,m,B,G,D);var P="<a href='"+mConst().url+k+".html?base="+n+"&graph="+E+"&fromhr="+g+"&tohr="+B+"&frommin="+m+"&tomin="+G+"&smart="+A+"&vers="+k+"&goneoff="+D+"&token="+i+"&age="+a+"&emailto="+encodeURIComponent(N)+"&noset=Y'>"+mConst().report+"</a><br/>";var O={from:"Morpheuz <noreply@morpheuz.co.uk>",to:N,subject:"Morpheuz-"+new Date(n).format("yyyy-MM-dd"),message:mConst().emailHeader2+P+mConst().emailHeader+Q.body+mConst().emailFooter1+mConst().emailFooter2};$("#mail").attr("disabled","disabled");$("#emailSendResult").removeClass("red").removeClass("green");$("#emailSendResult").text(mConst().sendingEmail);sendMailViaServer(O,function(R,S){if(R===1){$("#emailSendResult").addClass("green")}else{$("#emailSendResult").addClass("red")}$("#emailSendResult").text(S);$("#mail").removeAttr("disabled")})});$("#age").keyup(function(){var N=$("#age").val();$("#stats").text(buildRecommendationPhrase(N,F))})});